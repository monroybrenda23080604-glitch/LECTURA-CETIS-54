<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Biblioteca CETIS 54 ‚Äî Programa de Lectura</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    /* ======================
       VARIABLES Y RESET
       ====================== */
    :root{
      --bg-1: #fff8f4;
      --bg-2: #fff2ea;
      --card: rgba(255,255,255,0.82);
      --glass: rgba(255,255,255,0.65);
      --accent-1: #ff7a59;
      --accent-2: #ffb86b;
      --accent-3: #ffd4b2;
      --muted: #6b4f3b;
      --muted-2: rgba(107,79,59,0.65);
      --radius: 16px;
      --shadow-1: 0 8px 28px rgba(107,79,59,0.10);
      --shadow-2: 0 18px 50px rgba(107,79,59,0.12);
      --glass-border: rgba(107,79,59,0.06);
      --success: #2ecb84;
      --danger: #ff6b6b;
      --transition: 260ms cubic-bezier(.2,.9,.3,1);
      --max-width: 1200px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--muted);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background:linear-gradient(180deg,var(--bg-1),var(--bg-2));}
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}
    /* ======================
       LAYOUT
       ====================== */
    .wrap{max-width:var(--max-width);margin:28px auto;padding:20px;position:relative;overflow:visible}
    header{display:flex;justify-content:space-between;align-items:center;gap:16px;margin-bottom:20px}
    .brand{display:flex;gap:12px;align-items:center}
    .brand .logo{width:64px;height:64px;border-radius:14px;background:linear-gradient(180deg,var(--accent-3),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#6b3b2a;font-size:20px;box-shadow:var(--shadow-1)}
    h1{font-size:20px;color:#4b2f24}
    .subtitle{font-size:13px;color:var(--muted-2)}
    .header-actions{display:flex;align-items:center;gap:10px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));padding:10px 14px;border-radius:12px;color:white;border:0;cursor:pointer;font-weight:700;box-shadow:var(--shadow-1);transition:transform var(--transition), box-shadow var(--transition)}
    .btn:hover{transform:translateY(-3px);box-shadow:var(--shadow-2)}
    .btn.ghost{background:transparent;border:1px solid var(--glass-border);color:var(--muted);box-shadow:none;font-weight:600}
    /* background shapes (touristic warm feel) */
    .bg-shapes{position:fixed;left:-8%;top:-6%;width:120vw;height:120vh;pointer-events:none;z-index:0;overflow:hidden}
    .shape{
      position:absolute;border-radius:42%;
      filter:blur(48px);opacity:0.28;transform:rotate(15deg);
      mix-blend-mode:soft-light;
    }
    .shape.s1{width:520px;height:520px;left:-120px;top:-160px;background:linear-gradient(135deg,var(--accent-1),var(--accent-3));}
    .shape.s2{width:420px;height:420px;right:-80px;top:20px;background:linear-gradient(135deg,var(--accent-2),#fff0e6);opacity:0.24}
    .shape.s3{width:320px;height:320px;left:20%;bottom:-120px;background:linear-gradient(135deg,#ffd6b6,#fff1ea);opacity:0.18}
    /* layout grid */
    .layout{display:grid;grid-template-columns:320px 1fr;gap:22px;position:relative;z-index:5}
    @media (max-width:960px){ .layout{grid-template-columns:1fr} header{flex-direction:column;align-items:flex-start} }
    /* panel */
    .panel{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:var(--shadow-1);border:1px solid var(--glass-border);backdrop-filter: blur(6px)}
    /* SIDEBAR */
    .sidebar .profile{display:flex;gap:12px;align-items:center}
    .avatar{width:56px;height:56px;border-radius:12px;background:linear-gradient(180deg,#ffd8c7,#ffb38a);display:flex;align-items:center;justify-content:center;font-weight:800;color:#6b3b2a}
    nav{margin-top:18px;display:flex;flex-direction:column;gap:8px}
    nav button{background:transparent;border:0;padding:10px;border-radius:12px;text-align:left;cursor:pointer;font-weight:700;color:var(--muted-2);display:flex;gap:10px;align-items:center}
    nav button.active, nav button:hover{background:linear-gradient(90deg,rgba(255,122,89,0.12),rgba(255,184,107,0.06));color:#4b2f24}
    .muted{color:var(--muted-2)}
    /* MAIN */
    .controls{display:flex;gap:12px;align-items:center;margin-bottom:14px}
    .search{flex:1;display:flex;gap:10px;align-items:center}
    .search input{flex:1;padding:12px 14px;border-radius:12px;border:1px solid var(--glass-border);background:transparent;outline:none;transition:box-shadow var(--transition)}
    .search input:focus{box-shadow:0 8px 26px rgba(107,79,59,0.06)}
    .filter-row{display:flex;gap:8px;align-items:center}
    /* books grid */
    .books{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:14px}
    .card-book{background:linear-gradient(180deg, rgba(255,255,255,0.7), rgba(255,255,255,0.6));border-radius:12px;padding:12px;border:1px solid var(--glass-border);display:flex;flex-direction:column;gap:8px;transition:transform var(--transition), box-shadow var(--transition);position:relative;overflow:hidden}
    .card-book:hover{transform:translateY(-8px);box-shadow:var(--shadow-2)}
    .cover{width:100%;height:140px;border-radius:8px;object-fit:cover;box-shadow:inset 0 -8px 18px rgba(0,0,0,0.04)}
    .title{font-weight:700;font-size:15px;color:#3f2b22}
    .author{font-size:13px;color:var(--muted-2);min-height:34px}
    .book-meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
    .badge{padding:6px 8px;border-radius:10px;font-weight:800;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white;font-size:13px}
    .actions{display:flex;gap:8px}
    .icon-btn{display:inline-flex;align-items:center;justify-content:center;border-radius:10px;padding:8px;border:1px solid var(--glass-border);background:transparent;cursor:pointer}
    .icon-btn.heart.active{background:linear-gradient(90deg,#ffd6d0,#ffbdb3);border-color:rgba(255,90,60,0.14)}
    /* favorite badge floating */
    .fav-floating{position:absolute;right:10px;top:10px;z-index:3}
    /* modal */
    .modal{position:fixed;inset:0;background:rgba(7,6,5,0.48);display:none;align-items:center;justify-content:center;padding:18px;z-index:120}
    .modal.open{display:flex}
    .modal-card{width:100%;max-width:820px;border-radius:16px;padding:18px;background:linear-gradient(180deg,#fffdfa,#fff7f1);box-shadow:var(--shadow-2);border:1px solid var(--glass-border)}
    .modal-grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    @media (max-width:920px){ .modal-grid{grid-template-columns:1fr} .modal-card{padding:14px} }
    .close-btn{background:transparent;border:0;padding:6px;border-radius:8px;cursor:pointer}
    /* form inputs */
    .input{width:100%;padding:10px;border-radius:10px;border:1px solid var(--glass-border);background:transparent;margin-bottom:8px}
    .textarea{min-height:110px;padding:10px;border-radius:10px;border:1px solid var(--glass-border);background:transparent;resize:vertical}
    /* account */
    .account-compact{display:flex;align-items:center;gap:12px}
    .points-pill{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));padding:8px 12px;border-radius:999px;color:white;font-weight:800}
    .progress{height:10px;background:rgba(107,79,59,0.06);border-radius:999px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));width:0%;transition:width 600ms var(--transition)}
    /* admin table */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;text-align:left;border-bottom:1px solid rgba(107,79,59,0.06);font-size:14px}
    /* toast */
    .toast{position:fixed;right:18px;bottom:18px;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:white;padding:10px 14px;border-radius:12px;box-shadow:0 12px 34px rgba(0,0,0,0.12);z-index:140;display:none}
    .toast.show{display:block;animation:toastIn .32s ease}
    @keyframes toastIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
    /* confetti canvas */
    #confettiCanvas{position:fixed;left:0;top:0;width:100%;height:100%;pointer-events:none;z-index:200}
    /* subtle utilities */
    .muted-sm{font-size:13px;color:var(--muted-2)}
    .tiny{font-size:12px;color:var(--muted-2)}
  </style>
</head>
<body>
  <!-- Decorative warm shapes -->
  <div class="bg-shapes" aria-hidden="true">
    <div class="shape s1"></div>
    <div class="shape s2"></div>
    <div class="shape s3"></div>
  </div>

  <div class="wrap" role="main">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true">C54</div>
        <div>
          <h1>Biblioteca CETIS 54</h1>
          <div class="subtitle">Programa de Lectura ‚Äî canjea puntos y descubre historias</div>
        </div>
      </div>

      <div class="header-actions" role="region" aria-label="Acciones">
        <div id="userBadgeArea" class="account-compact" aria-live="polite"></div>
        <button id="openAuth" class="btn" aria-haspopup="dialog"><span class="tiny">Cuenta</span> Iniciar / Registro</button>
      </div>
    </header>

    <div class="layout" role="application">
      <!-- SIDEBAR -->
      <aside class="panel sidebar" aria-label="Navegaci√≥n">
        <div class="profile">
          <div class="avatar">C54</div>
          <div>
            <div style="font-weight:800">Biblioteca CETIS 54</div>
            <div class="muted-sm">Programa de incentivos ‚Äî c√°lido y tur√≠stico</div>
          </div>
        </div>

        <nav aria-label="Secciones">
          <button data-view="catalog" class="active">üìö Cat√°logo</button>
          <button data-view="miCuenta">üë§ Mi cuenta</button>
          <button data-view="admin">‚öôÔ∏è Admin</button>
        </nav>

        <div style="margin-top:14px" class="muted-sm">Puntos por rese√±a: <strong id="pointsPerReview">10</strong></div>
        <div style="margin-top:12px" class="muted-sm">Puntos para canje: <strong id="pointsToRedeem">100</strong></div>
      </aside>

      <!-- MAIN AREA -->
      <main>
        <!-- Catalog -->
        <section id="view-catalog" class="panel" data-view="catalog" aria-labelledby="catalog-title">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <div>
              <h2 id="catalog-title" style="margin:0">Cat√°logo destacado</h2>
              <div class="tiny muted-sm">Explora, rese√±a y gana recompensas</div>
            </div>
            <div class="tiny muted-sm">Total <span id="booksCount">0</span> libros</div>
          </div>

          <div class="controls">
            <div class="search" role="search" aria-label="Buscar libro">
              <input id="searchInput" type="text" placeholder="Buscar por t√≠tulo o autor..." aria-label="Buscar libro">
              <button id="btnSearch" class="btn ghost">üîé Buscar</button>
            </div>

            <div class="filter-row">
              <select id="sortSelect" class="input" aria-label="Ordenar">
                <option value="relevance">M√°s relevantes</option>
                <option value="reads">M√°s le√≠dos</option>
                <option value="title">A - Z</option>
              </select>
              <button id="btnRefresh" class="btn ghost">‚ü≥ Actualizar</button>
            </div>
          </div>

          <div class="books" id="booksGrid" aria-live="polite"></div>
        </section>

        <!-- My account -->
        <section id="view-miCuenta" class="panel" data-view="miCuenta" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h2 style="margin:0">Mi cuenta</h2>
            <div class="tiny muted-sm">Controla tus rese√±as y canjes</div>
          </div>

          <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:220px" class="panel" aria-label="Perfil">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div>
                  <div class="tiny muted-sm">Nombre</div>
                  <div id="meName" style="font-weight:800">-</div>
                </div>
                <div style="text-align:right">
                  <div class="tiny muted-sm">Puntos</div>
                  <div id="mePoints" class="points-pill">0</div>
                </div>
              </div>
              <div style="height:12px"></div>
              <div class="tiny muted-sm">Progreso hacia canje</div>
              <div class="progress" style="margin-top:8px"><i id="progressBar"></i></div>
            </div>

            <div style="flex:2;min-width:260px" class="panel">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div class="tiny muted-sm">Libros le√≠dos</div>
                <div class="tiny muted-sm">Rese√±as: <strong id="meBooksCount">0</strong></div>
              </div>
              <ul id="meBooks" style="margin-top:8px"></ul>
            </div>
          </div>

          <div style="margin-top:12px">
            <h3 style="margin-bottom:8px">Rese√±as enviadas</h3>
            <div id="myReviews"></div>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px;">
            <button id="btnRedeem" class="btn">üéÅ Canjear</button>
            <button id="btnMyFavorites" class="btn ghost">‚≠ê Mis favoritos</button>
          </div>
        </section>

        <!-- Admin -->
        <section id="view-admin" class="panel" data-view="admin" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h2 style="margin:0">Admin</h2>
            <div class="tiny muted-sm">Gestiona cat√°logo y usuarios</div>
          </div>

          <div style="display:flex;gap:12px;margin-top:12px;flex-wrap:wrap">
            <div style="flex:1;min-width:280px">
              <h4>Agregar libro</h4>
              <input id="newTitle" class="input" placeholder="T√≠tulo">
              <input id="newImage" class="input" placeholder="URL portada (opcional)">
              <input id="newDesc" class="input" placeholder="Descripci√≥n corta">
              <div style="display:flex;gap:8px;margin-top:8px">
                <button id="btnAddBook" class="btn">Agregar</button>
                <button id="btnSeed" class="btn ghost">Restablecer seed</button>
              </div>
            </div>

            <div style="flex:2;min-width:320px">
              <h4>Usuarios</h4>
              <div style="max-height:220px;overflow:auto;margin-top:8px">
                <table id="usersTable"><thead><tr><th>Nombre</th><th>Email</th><th>Puntos</th><th>Libros</th></tr></thead><tbody></tbody></table>
              </div>
            </div>
          </div>

          <div style="margin-top:12px">
            <h4>Rese√±as</h4>
            <div id="adminReviews" style="max-height:260px;overflow:auto"></div>
          </div>
        </section>

      </main>
    </div>

    <footer style="margin-top:18px;text-align:center;color:var(--muted-2);font-size:13px">Dise√±ado para Biblioteca CETIS 54 ‚Äî ¬© Programa de Lectura</footer>
  </div>

  <!-- Modal (Login/Register/Review/BookDetail) -->
  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-card" role="document">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <h3 id="modalTitle" style="margin:0">Cuenta</h3>
          <div id="modalSubtitle" class="tiny muted-sm"></div>
        </div>
        <div>
          <button id="closeModal" class="close-btn" aria-label="Cerrar">‚úï</button>
        </div>
      </div>
      <div id="modalBody" style="margin-top:12px"></div>
    </div>
  </div>

  <!-- Toast & Confetti Canvas -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <canvas id="confettiCanvas"></canvas>

  <script>
    /*******************************
     * App constants & state
     *******************************/
    const API_URL = ''; // si usas backend pon aqu√≠ la url
    const POINTS_PER_REVIEW = 10;
    const POINTS_TO_REDEEM = 100;

    let state = {
      user: null,
      books: [],
      reviews: [],
      users: [],
      favorites: []
    };

    // seed libros (calidez - tur√≠stica)
    const seedBooks = [
      {id:'b1', title:'Cien a√±os de soledad', img:'https://www.rae.es/sites/default/files/styles/obra_portada_ficha/public/portada_cien_anos_de_soledad_0.jpg?itok=DDV1xNqg', desc:'Gabriel Garc√≠a M√°rquez', reads:12},
      {id:'b2', title:'El principito', img:'https://picsum.photos/seed/2/600/380', desc:'Antoine de Saint-Exup√©ry', reads:23},
      {id:'b3', title:'La Odisea', img:'https://picsum.photos/seed/3/600/380', desc:'Homero', reads:8},
      {id:'b4', title:'Don Quijote', img:'https://picsum.photos/seed/4/600/380', desc:'Miguel de Cervantes', reads:15},
      {id:'b5', title:'1984', img:'https://picsum.photos/seed/5/600/380', desc:'George Orwell', reads:9},
      {id:'b6', title:'El Hobbit', img:'https://picsum.photos/seed/6/600/380', desc:'J.R.R. Tolkien', reads:31},
      {id:'b7', title:'Rayuela', img:'https://picsum.photos/seed/7/600/380', desc:'Julio Cort√°zar', reads:6},
      {id:'b8', title:'La tregua', img:'https://picsum.photos/seed/8/600/380', desc:'Mario Benedetti', reads:10},
      {id:'b9', title:'Ficciones', img:'https://picsum.photos/seed/9/600/380', desc:'Jorge Luis Borges', reads:7},
      {id:'b10', title:'Cr√≥nica de una muerte anunciada', img:'https://picsum.photos/seed/10/600/380', desc:'Gabriel Garc√≠a M√°rquez', reads:11}
    ];

    /*******************************
     * Helpers DOM
     *******************************/
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));
    const toastEl = $('#toast');

    function showToast(msg, ms=2800){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      toastEl.style.display = 'block';
      setTimeout(()=>{ toastEl.classList.remove('show'); toastEl.style.display = 'none'; }, ms);
    }

    /*******************************
     * Confetti (minimal canvas)
     *******************************/
    const confettiCanvas = $('#confettiCanvas');
    const confettiCtx = confettiCanvas.getContext('2d');
    let confettiParticles = [];
    function resizeCanvas(){ confettiCanvas.width = window.innerWidth; confettiCanvas.height = window.innerHeight; }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function spawnConfetti(amount=40){
      for(let i=0;i<amount;i++){
        confettiParticles.push({
          x: Math.random()*confettiCanvas.width,
          y: -20 - Math.random()*200,
          vx: Math.random()*6 - 3,
          vy: Math.random()*3 + 2,
          size: Math.random()*8 + 4,
          color: ['#ffd6b6','#ffb86b','#ff7a59','#ffe3d6'][Math.floor(Math.random()*4)],
          rot: Math.random()*360
        });
      }
      if(!confettiRunning) runConfetti();
    }
    let confettiRunning = false;
    function runConfetti(){
      confettiRunning = true;
      const step = ()=>{
        confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
        confettiParticles.forEach((p, i) => {
          p.x += p.vx; p.y += p.vy; p.vy += 0.04;
          confettiCtx.save();
          confettiCtx.translate(p.x,p.y);
          confettiCtx.rotate(p.rot * Math.PI/180);
          confettiCtx.fillStyle = p.color;
          confettiCtx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6);
          confettiCtx.restore();
          if(p.y > confettiCanvas.height + 40) confettiParticles.splice(i,1);
        });
        if(confettiParticles.length) requestAnimationFrame(step);
        else { confettiRunning = false; confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height); }
      };
      requestAnimationFrame(step);
    }

    /*******************************
     * INIT
     *******************************/
    function init(){
      // seed
      state.books = seedBooks.slice();
      // load local data
      const sUser = localStorage.getItem('cetis_user');
      const sUsers = localStorage.getItem('cetis_users');
      const sReviews = localStorage.getItem('cetis_reviews');
      const sFav = localStorage.getItem('cetis_favorites');
      if(sUser) state.user = JSON.parse(sUser);
      state.users = sUsers? JSON.parse(sUsers) : [];
      state.reviews = sReviews? JSON.parse(sReviews) : [];
      state.favorites = sFav? JSON.parse(sFav) : [];

      // hooks
      $('#openAuth').addEventListener('click', openAuthModal);
      $('#closeModal').addEventListener('click', closeModal);
      $('#btnRefresh').addEventListener('click', ()=>{ refreshAllData(); showToast('Cat√°logo actualizado'); });
      $('#btnSearch').addEventListener('click', doSearch);
      $('#searchInput').addEventListener('keyup', e => { if(e.key==='Enter') doSearch(); });

      $$('nav button').forEach(btn => {
        btn.addEventListener('click', ev => {
          const view = ev.currentTarget.dataset.view;
          switchView(view);
          $$('nav button').forEach(b => b.classList.remove('active'));
          ev.currentTarget.classList.add('active');
        });
      });

      $('#btnAddBook').addEventListener('click', adminAddBook);
      $('#btnSeed').addEventListener('click', ()=>{ state.books = seedBooks.slice(); renderBooks(); showToast('Seed restablecido'); });
      $('#btnRedeem').addEventListener('click', redeemBook);
      $('#btnMyFavorites').addEventListener('click', ()=>{ renderFavoritesModal(); openModal('Favoritos', '') });

      // initial render
      document.getElementById('pointsPerReview').textContent = POINTS_PER_REVIEW;
      document.getElementById('pointsToRedeem').textContent = POINTS_TO_REDEEM;
      renderUserBadge();
      renderBooks();
      renderAdmin();
    }

    /*******************************
     * VIEWS / RENDER
     *******************************/
    function renderUserBadge(){
      const el = $('#userBadgeArea');
      if(state.user){
        el.innerHTML = `
          <div style="display:flex;align-items:center;gap:8px">
            <div style="font-weight:800;color:var(--accent-1)">${escapeHtml(state.user.nombre || state.user.email)}</div>
            <div class="points-pill">${state.user.puntos || 0} pts</div>
            <button id="logoutBtn" class="btn ghost" title="Cerrar sesi√≥n">Salir</button>
          </div>
        `;
        $('#logoutBtn').addEventListener('click', ()=>{ state.user=null; localStorage.removeItem('cetis_user'); renderUserBadge(); renderMyAccount(); showToast('Sesi√≥n cerrada'); });
      } else {
        el.innerHTML = '';
      }
    }

    function renderBooks(filter, sort='relevance'){
      const grid = $('#booksGrid');
      grid.innerHTML = '';
      let list = state.books.slice();

      if(filter) {
        const q = filter.toLowerCase();
        list = list.filter(b => (b.title + ' ' + (b.desc||'')).toLowerCase().includes(q));
      }

      if(sort === 'reads') list.sort((a,b)=> (b.reads||0) - (a.reads||0));
      if(sort === 'title') list.sort((a,b)=> a.title.localeCompare(b.title));

      $('#booksCount').textContent = list.length;

      list.forEach(b => {
        const div = document.createElement('div');
        div.className = 'card-book';
        div.innerHTML = `
          <div class="fav-floating">
            <button class="icon-btn heart" data-id="${b.id}" aria-label="Favorito">
              <span class="tiny">‚òÜ</span>
            </button>
          </div>
          <img class="cover" src="${b.img}" alt="${escapeHtml(b.title)} portada">
          <div><div class="title">${escapeHtml(b.title)}</div><div class="author">${escapeHtml(b.desc||'')}</div></div>
          <div class="book-meta">
            <div class="tiny muted-sm">Lecturas: <strong>${b.reads||0}</strong></div>
            <div class="actions">
              <button class="icon-btn" data-id="${b.id}" data-action="view" aria-label="Ver detalles">üëÅÔ∏è</button>
              <button class="btn" data-id="${b.id}" data-action="review">Rese√±ar</button>
            </div>
          </div>
        `;
        grid.appendChild(div);

        // favorite toggle
        const favBtn = div.querySelector('.heart');
        if(state.favorites.includes(b.id)) favBtn.classList.add('active');
        favBtn.addEventListener('click', ()=>{ toggleFavorite(b.id, favBtn); });

        // view & review
        div.querySelector('[data-action="view"]').addEventListener('click', ()=> openBookDetail(b));
        div.querySelector('[data-action="review"]').addEventListener('click', ()=> openReviewModal(b));
      });
    }

    function renderAdmin(){
      const tbody = document.querySelector('#usersTable tbody');
      tbody.innerHTML = '';
      state.users.forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(u.nombre)}</td><td>${escapeHtml(u.email)}</td><td>${u.puntos||0}</td><td>${u.librosLeidos||0}</td>`;
        tbody.appendChild(tr);
      });

      const ar = $('#adminReviews');
      ar.innerHTML = '';
      (state.reviews || []).forEach(r=>{
        const u = state.users.find(x=>x.userId==r.userId) || {nombre:'-'}; const book = state.books.find(b=>b.id==r.libroId) || {title:'-'};
        const d = document.createElement('div');
        d.style.marginBottom = '8px';
        d.style.padding = '10px';
        d.style.borderRadius = '10px';
        d.style.background = 'linear-gradient(180deg,#fffaf6,#fff6ef)';
        d.innerHTML = `<strong>${escapeHtml(u.nombre)}</strong> sobre <em>${escapeHtml(book.title)}</em><div class="tiny muted-sm" style="margin-top:6px">${escapeHtml(r.texto)}</div>`;
        ar.appendChild(d);
      });
    }

    function renderMyAccount(){
      if(!state.user){ $('#meName').textContent='-'; $('#mePoints').textContent='0'; $('#meBooks').innerHTML=''; $('#myReviews').innerHTML=''; $('#progressBar').style.width='0%'; $('#meBooksCount').textContent='0'; return; }
      $('#meName').textContent = state.user.nombre || state.user.email;
      $('#mePoints').textContent = state.user.puntos || 0;
      $('#meBooksCount').textContent = state.user.librosLeidos || 0;

      // reviews
      const userReviews = (state.reviews || []).filter(r=> r.userId == state.user.userId);
      const myList = $('#myReviews'); myList.innerHTML = '';
      userReviews.forEach(r=>{
        const book = state.books.find(b=>b.id==r.libroId) || {title:'-'};
        const card = document.createElement('div');
        card.style.marginBottom='8px'; card.style.padding='10px'; card.style.borderRadius='10px'; card.style.background='linear-gradient(180deg,#fffaf6,#fff6ef)';
        card.innerHTML = `<strong>${escapeHtml(book.title)}</strong><div class="tiny muted-sm" style="margin-top:6px">${escapeHtml(r.texto)}</div>`;
        myList.appendChild(card);
      });

      // book list
      const mb = $('#meBooks'); mb.innerHTML = '';
      userReviews.forEach(r => {
        const b = state.books.find(x=>x.id==r.libroId) || {title:'-'};
        const li = document.createElement('li'); li.textContent = `${b.title} ‚Äî ${r.texto}`;
        mb.appendChild(li);
      });

      // progress
      const percent = Math.min(100, Math.round(((state.user.puntos||0) / POINTS_TO_REDEEM) * 100));
      $('#progressBar').style.width = percent + '%';
    }

    /*******************************
     * ACTIONS: Favorites, View, Review
     *******************************/
    function toggleFavorite(bookId, btnEl){
      if(!state.favorites) state.favorites = [];
      const idx = state.favorites.indexOf(bookId);
      if(idx >= 0){ state.favorites.splice(idx,1); btnEl.classList.remove('active'); showToast('Quitado de favoritos'); }
      else { state.favorites.push(bookId); btnEl.classList.add('active'); showToast('A√±adido a favoritos'); }
      localStorage.setItem('cetis_favorites', JSON.stringify(state.favorites));
    }

    function openBookDetail(book){
      const body = $('#modalBody');
      body.innerHTML = `
        <div class="modal-grid">
          <div>
            <img src="${book.img}" alt="${escapeHtml(book.title)}" style="width:100%;border-radius:12px;height:320px;object-fit:cover">
            <h3 style="margin-top:10px">${escapeHtml(book.title)}</h3>
            <div class="tiny muted-sm">${escapeHtml(book.desc||'')}</div>
            <p class="muted-sm" style="margin-top:8px">Lecturas: <strong>${book.reads||0}</strong></p>
            <div style="margin-top:12px">
              <button id="openReviewFromDetail" class="btn">‚úçÔ∏è Escribir rese√±a</button>
              <button id="favFromDetail" class="btn ghost" style="margin-left:8px">‚≠ê Favorito</button>
            </div>
          </div>
          <div style="padding:6px">
            <h4>Rese√±as</h4>
            <div id="detailReviews" style="max-height:380px;overflow:auto;margin-top:8px"></div>
          </div>
        </div>
      `;
      $('#modalTitle').textContent = book.title;
      $('#modalSubtitle').textContent = book.desc || '';
      openModal();

      // render reviews
      const dr = $('#detailReviews'); dr.innerHTML = '';
      (state.reviews || []).filter(r=>r.libroId==book.id).forEach(r => {
        const u = state.users.find(x=>x.userId==r.userId) || {nombre:'An√≥nimo'};
        const d = document.createElement('div');
        d.style.padding='8px'; d.style.marginBottom='8px'; d.style.borderRadius='8px'; d.style.background='#fff9f5';
        d.innerHTML = `<strong>${escapeHtml(u.nombre)}</strong><div class="tiny muted-sm" style="margin-top:6px">${escapeHtml(r.texto)}</div>`;
        dr.appendChild(d);
      });

      $('#openReviewFromDetail').addEventListener('click', ()=>{ closeModal(); setTimeout(()=> openReviewModal(book), 180); });
      $('#favFromDetail').addEventListener('click', ()=>{ const btn = document.querySelector(`.heart[data-id="${book.id}"]`); toggleFavorite(book.id, btn); });
    }

    function openReviewModal(book){
      if(!state.user){ openAuthModal('login'); return; }
      const body = $('#modalBody');
      body.innerHTML = `
        <div>
          <h3>Rese√±a ‚Äî ${escapeHtml(book.title)}</h3>
          <textarea id="reviewText" class="textarea" placeholder="Escribe tu rese√±a..."></textarea>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="sendReview" class="btn">Enviar rese√±a (+${POINTS_PER_REVIEW} pts)</button>
            <button id="cancelReview" class="btn ghost">Cancelar</button>
          </div>
        </div>
      `;
      $('#modalTitle').textContent = 'Rese√±a';
      $('#modalSubtitle').textContent = `Libro: ${book.title}`;
      openModal();
      $('#cancelReview').addEventListener('click', closeModal);
      $('#sendReview').addEventListener('click', ()=> submitReview(book));
    }

    function submitReview(book){
      const text = $('#reviewText').value.trim();
      if(!text){ alert('Escribe algo por favor'); return; }
      const payload = { action:'guardarResena', userId: state.user.userId || state.user.userId, libroId: book.id, texto: text };
      if(API_URL){
        apiPost(payload).then(res=>{
          if(res.status === 'ok'){ showToast('Rese√±a guardada'); closeModal(); refreshAllData(); }
          else alert(res.msg || 'error');
        }).catch(()=> alert('Error de conexi√≥n'));
      } else {
        const r = { resenaId: 'r'+Date.now(), userId: state.user.userId, libroId: book.id, texto: text, fecha: new Date().toISOString() };
        state.reviews.push(r);
        // sumar puntos localmente
        state.user.puntos = (state.user.puntos || 0) + POINTS_PER_REVIEW;
        state.user.librosLeidos = (state.user.librosLeidos || 0) + 1;
        // persistir
        const idx = state.users.findIndex(u => u.userId === state.user.userId);
        if(idx >= 0) { state.users[idx] = { ...state.users[idx], puntos: state.user.puntos, librosLeidos: state.user.librosLeidos }; localStorage.setItem('cetis_users', JSON.stringify(state.users)); }
        localStorage.setItem('cetis_user', JSON.stringify(state.user));
        localStorage.setItem('cetis_reviews', JSON.stringify(state.reviews));
        closeModal();
        showToast(`+${POINTS_PER_REVIEW} pts`);
        animatePointsGain(POINTS_PER_REVIEW);
        spawnConfetti(28);
        refreshAllData();
      }
    }

    /*******************************
     * AUTH (local fallback)
     *******************************/
    function openAuthModal(mode = 'login'){
      const body = $('#modalBody');
      if(mode === 'register'){
        body.innerHTML = `
          <div style="display:flex;flex-direction:column;gap:8px">
            <h3>Registro</h3>
            <input id="regName" class="input" placeholder="Nombre">
            <input id="regEmail" class="input" placeholder="Email">
            <input id="regPass" type="password" class="input" placeholder="Contrase√±a">
            <div style="display:flex;gap:8px">
              <button id="doRegister" class="btn">Crear cuenta</button>
              <button id="backToLogin" class="btn ghost">Volver</button>
            </div>
          </div>
        `;
        $('#doRegister').addEventListener('click', userRegister);
        $('#backToLogin').addEventListener('click', ()=> openAuthModal('login'));
        $('#modalTitle').textContent = 'Registro';
        $('#modalSubtitle').textContent = 'Crea tu cuenta para participar';
        openModal();
        return;
      }

      // login
      body.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <h3>Iniciar sesi√≥n</h3>
            <input id="loginEmail" class="input" placeholder="Email">
            <input id="loginPass" type="password" class="input" placeholder="Contrase√±a">
            <div style="display:flex;gap:8px;margin-top:8px">
              <button id="doLogin" class="btn">Iniciar</button>
              <button id="toRegister" class="btn ghost">Registrarme</button>
            </div>
            <div style="margin-top:10px" class="tiny muted-sm">¬øOlvidaste tu contrase√±a? Contacta al administrador.</div>
          </div>
          <div style="border-left:1px dashed rgba(107,79,59,0.04);padding-left:12px">
            <h4>Ventajas</h4>
            <ul style="margin-top:6px;">
              <li>Gana <strong>${POINTS_PER_REVIEW} pts</strong> por rese√±a</li>
              <li>Canjea libros con <strong>${POINTS_TO_REDEEM} pts</strong></li>
              <li>Guarda favoritos</li>
            </ul>
          </div>
        </div>
      `;
      $('#doLogin').addEventListener('click', userLogin);
      $('#toRegister').addEventListener('click', ()=> openAuthModal('register'));
      $('#modalTitle').textContent = 'Cuenta';
      $('#modalSubtitle').textContent = 'Inicia sesi√≥n o reg√≠strate';
      openModal();
    }

    function userLogin(){
      const email = $('#loginEmail').value?.trim();
      const pass = $('#loginPass').value || '';
      if(!email){ alert('Ingrese email'); return; }
      if(API_URL){
        apiPost({action:'login', email}).then(res=>{
          if(res.status === 'ok'){ state.user = res.data; localStorage.setItem('cetis_user', JSON.stringify(state.user)); closeModal(); renderUserBadge(); refreshAllData(); showToast('Bienvenido ' + (state.user.nombre || '')); }
          else alert(res.msg || 'No encontrado');
        }).catch(()=> alert('Error red'));
      } else {
        const u = state.users.find(x=>x.email === email && (x.pass? x.pass === pass : true));
        if(!u){ alert('Usuario no encontrado. Reg√≠strate.'); return; }
        state.user = u; localStorage.setItem('cetis_user', JSON.stringify(u));
        closeModal(); renderUserBadge(); refreshAllData(); showToast('Sesi√≥n iniciada');
      }
    }

    function userRegister(){
      const name = $('#regName').value?.trim();
      const email = $('#regEmail').value?.trim();
      const pass = $('#regPass').value || '';
      if(!name || !email){ alert('Completa nombre y email'); return; }
      if(API_URL){
        apiPost({action:'registrarUsuario', nombre:name, email}).then(res=>{
          if(res.status==='ok'){ state.user = { userId: res.data.userId, nombre: name, email, puntos:0, librosLeidos:0 }; localStorage.setItem('cetis_user', JSON.stringify(state.user)); closeModal(); renderUserBadge(); refreshAllData(); showToast('Registrado correctamente'); }
          else alert(res.msg || 'error');
        }).catch(()=> alert('Error red'));
      } else {
        const u = { userId: 'u' + Date.now(), nombre: name, email, pass, puntos:0, librosLeidos:0 };
        state.users.push(u);
        localStorage.setItem('cetis_users', JSON.stringify(state.users));
        state.user = u; localStorage.setItem('cetis_user', JSON.stringify(u));
        closeModal(); renderUserBadge(); refreshAllData(); showToast('Cuenta creada ‚Äî ' + name);
      }
    }

    /*******************************
     * Admin add / seed / refresh
     *******************************/
    function adminAddBook(){
      const title = $('#newTitle').value.trim();
      const img = $('#newImage').value.trim() || ('https://picsum.photos/seed/'+Date.now()+'/600/380');
      const desc = $('#newDesc').value.trim();
      if(!title){ alert('Escribe t√≠tulo'); return; }
      if(API_URL){
        apiPost({action:'agregarLibro', nombre:title, imagen:img, descripcion:desc}).then(res=>{ if(res.status==='ok'){ showToast('Libro agregado'); refreshAllData(); } else alert(res.msg||'error'); });
      } else {
        const book = { id:'b'+Date.now(), title, img, desc, reads:0 };
        state.books.push(book);
        renderBooks();
        showToast('Libro agregado localmente');
      }
    }

    /*******************************
     * Redeem
     *******************************/
    function redeemBook(){
      if(!state.user){ openAuthModal('login'); return; }
      if((state.user.puntos||0) < POINTS_TO_REDEEM){ alert('No tienes suficientes puntos'); return; }
      const chosen = prompt('Escribe el t√≠tulo exacto del libro que deseas canjear (ver cat√°logo):');
      if(!chosen) return;
      const book = state.books.find(b => b.title.toLowerCase() === chosen.toLowerCase());
      if(!book){ alert('Libro no encontrado'); return; }
      if(API_URL){
        apiPost({action:'guardarCanje', userId: state.user.userId, libroId: book.id}).then(res=>{ if(res.status==='ok'){ showToast('Canje registrado'); refreshAllData(); } else alert(res.msg||'error'); });
      } else {
        state.user.puntos -= POINTS_TO_REDEEM;
        const idx = state.users.findIndex(u => u.userId === state.user.userId);
        if(idx >= 0){ state.users[idx] = {...state.users[idx], puntos: state.user.puntos}; localStorage.setItem('cetis_users', JSON.stringify(state.users)); }
        localStorage.setItem('cetis_user', JSON.stringify(state.user));
        showToast('Canje realizado ‚Äî disfruta tu libro');
        renderMyAccount();
      }
    }

    /*******************************
     * Utility & modal helpers
     *******************************/
    function openModal(){ $('#modal').classList.add('open'); $('#modal').setAttribute('aria-hidden','false'); }
    function closeModal(){ $('#modal').classList.remove('open'); $('#modal').setAttribute('aria-hidden','true'); }
    $('#closeModal').addEventListener('click', closeModal);
    window.addEventListener('keydown', e => { if(e.key==='Escape') closeModal(); });

    function openModalWithContent(title, subtitle, htmlContent){
      $('#modalTitle').textContent = title;
      $('#modalSubtitle').textContent = subtitle || '';
      $('#modalBody').innerHTML = htmlContent || '';
      openModal();
    }

    function openModal(title='Detalle', content=''){ $('#modalTitle').textContent = title; openModal(); }

    function escapeHtml(str){ return (str||'').toString().replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[s])); }

    /*******************************
     * Search & refresh
     *******************************/
    function doSearch(){
      const q = $('#searchInput').value.trim();
      const sort = $('#sortSelect') ? $('#sortSelect').value : 'relevance';
      renderBooks(q, sort);
    }

    function refreshAllData(){
      if(!API_URL){
        const lu = localStorage.getItem('cetis_users'); state.users = lu? JSON.parse(lu) : state.users;
        const lr = localStorage.getItem('cetis_reviews'); state.reviews = lr? JSON.parse(lr) : state.reviews;
        const lf = localStorage.getItem('cetis_favorites'); state.favorites = lf? JSON.parse(lf) : state.favorites;
        renderBooks();
        renderAdmin();
        renderUserBadge();
        renderMyAccount();
        return;
      }
      Promise.all([
        apiPost({action:'listarLibros'}).catch(()=>({status:'error'})),
        apiPost({action:'listarUsuarios'}).catch(()=>({status:'error'})),
        apiPost({action:'listarResenas'}).catch(()=>({status:'error'}))
      ]).then(([lb,lu,lr])=>{
        if(lb && lb.status==='ok'){ const rows = lb.data; const books = []; if(Array.isArray(rows)) rows.forEach(r=>{ if(Array.isArray(r)){ const [id,nombre,imagen,descripcion,reads] = r; if(id) books.push({id: id.toString(), title: nombre.toString(), img: imagen||'https://picsum.photos/seed/'+Math.random()+'/600/380', desc: descripcion||'', reads: parseInt(reads)||0}); } }); if(books.length) state.books = books; else state.books = seedBooks; }
        if(lu && lu.status==='ok'){ const rows = lu.data; const users = []; if(Array.isArray(rows)) rows.forEach(r=>{ if(Array.isArray(r)){ const [id,nombre,email,puntos,libros] = r; if(id) users.push({userId:id.toString(), nombre: nombre||email, email: email||'', puntos: parseInt(puntos)||0, librosLeidos: parseInt(libros)||0}); } }); state.users = users; }
        if(lr && lr.status==='ok'){ const rows = lr.data; const reviews = []; if(Array.isArray(rows)) rows.forEach(r=>{ if(Array.isArray(r)){ const [id,userId,libroId,texto,fecha] = r; if(id) reviews.push({resenaId:id.toString(), userId: userId?userId.toString():'', libroId: libroId?libroId.toString():'', texto: texto||'', fecha}); } }); state.reviews = reviews; }
        renderBooks(); renderAdmin(); renderUserBadge(); renderMyAccount();
      }).catch(e=>{ console.warn('refresh error', e); renderBooks(); renderAdmin(); renderMyAccount(); });
    }

    async function apiPost(payload){
      try{
        const params = new URLSearchParams(payload);
        const resp = await fetch(API_URL + (API_URL.includes('?')? '&':'?') + params.toString(), { method:'POST' });
        return await resp.json();
      } catch(e){ return {status:'error', msg: e.message } }
    }

    /*******************************
     * UI niceties: points animation
     *******************************/
    function animatePointsGain(points){
      const el = document.createElement('div');
      el.textContent = `+${points} pts`;
      Object.assign(el.style,{position:'fixed',right:'30px',bottom:'120px',padding:'10px 14px',background:'linear-gradient(90deg,var(--accent-1),var(--accent-2))',color:'white',borderRadius:'12px',boxShadow:'0 12px 30px rgba(0,0,0,0.12)',fontWeight:800,zIndex:300});
      document.body.appendChild(el);
      requestAnimationFrame(()=>{ el.style.transform = 'translateY(-70px)'; el.style.opacity = '1'; el.style.transition = 'transform 900ms cubic-bezier(.2,.9,.3,1), opacity 700ms'; });
      setTimeout(()=>{ el.style.opacity = 0; el.style.transform = 'translateY(-130px)'; }, 1600);
      setTimeout(()=> el.remove(), 2300);
    }

    /*******************************
     * Favorites modal (quick view)
     *******************************/
    function renderFavoritesModal(){
      const favs = (state.favorites || []).map(id => state.books.find(b=>b.id==id)).filter(Boolean);
      let html = `<h4>Favoritos (${favs.length})</h4>`;
      if(!favs.length) html += `<div class="tiny muted-sm">No tienes favoritos a√∫n</div>`;
      else{
        html += `<div style="display:grid;gap:8px;margin-top:8px">`;
        favs.forEach(b => { html += `<div style="padding:8px;border-radius:10px;background:#fff9f5;display:flex;align-items:center;gap:8px"><img src="${b.img}" style="width:60px;height:44px;object-fit:cover;border-radius:8px"><div><strong>${escapeHtml(b.title)}</strong><div class="tiny muted-sm">${escapeHtml(b.desc||'')}</div></div></div>` });
        html += `</div>`;
      }
      $('#modalBody').innerHTML = html;
      $('#modalTitle').textContent = 'Favoritos';
      openModal();
    }

    /*******************************
     * Minor: animate on page load & helpers
     *******************************/
    function switchView(view){
      $$('[data-view]').forEach(el => el.style.display = 'none');
      const sel = document.querySelector(`[data-view="${view}"]`);
      if(sel) sel.style.display = 'block';
      if(view === 'miCuenta') renderMyAccount();
      if(view === 'admin') renderAdmin();
    }

    // helpers
    function openAuthModal(){ openAuthModal; openAuthModal; openAuthModal; } // placeholder (not used)
    // fix earlier accidental redefinition; the real function is above: openAuthModal(mode)
    // wire nav default
    window.addEventListener('load', ()=>{ init(); switchView('catalog'); });

    /*******************************
     * Small: animate on review submit already handled
     *******************************/

    // Expose some functions globally to keep compatibility
    window.refreshAllData = refreshAllData;
    window.renderBooks = renderBooks;
    window.openLogin = ()=> openAuthModal('login');
    window.openRegister = ()=> openAuthModal('register');

    // small fix: ensure openAuthModal reference bound
    // (openAuthModal already defined earlier, so no-op here)

  </script>
</body>
</html>
